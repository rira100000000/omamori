# frozen_string_literal: true

require 'sinatra'

# 不適切なクッキー属性（HttpOnly, Secure, SameSite 未設定）の脆弱性を含むデモコード
# セキュリティ関連の属性が設定されていないクッキーを発行する例

# ログイン成功時にセッションクッキーを発行する想定のエンドポイント
get '/login' do
  user_id = params['user_id'] # ダミーのユーザーID取得

  # セッションIDをクッキーに設定
  # HttpOnly, Secure, SameSite 属性が設定されていない
  # これにより、XSS攻撃によるクッキー情報の窃盗や、CSRF攻撃のリスクが高まる
  response.set_cookie('session_id', value: "user_#{user_id}_#{Time.now.to_i}")

  "Logged in as user #{user_id}. Session cookie set."
end

# 実行方法:
# 1. このファイルを保存
# 2. ターミナルで `ruby demo/insecure_cookie_vulnerability.rb` を実行
# 3. ブラウザで `http://localhost:4567/login?user_id=test_user` にアクセス
#    開発者ツールなどでクッキーを確認すると、session_id クッキーに HttpOnly, Secure, SameSite 属性が付与されていないことがわかる。
#    HTTPSでアクセスした場合でもSecure属性が付かない。
