# frozen_string_literal: true

require 'sinatra'

# IDOR (Insecure Direct Object Reference) の脆弱性を含むデモコード
# ユーザーからの入力（ID）を直接使用してリソースにアクセスし、認可チェックを行っていない例

# ユーザー情報を表示する想定のエンドポイント
get '/user_info/:user_id' do
  user_id = params['user_id']

  # 本来はここで、リクエストを行ったユーザーが、指定された user_id の情報にアクセスする権限があるかチェックが必要だが、省略されている
  user_data = fetch_user_data(user_id) # ユーザーIDに基づいてデータを取得する関数を想定

  if user_data
    "User Info for ID #{user_id}: #{user_data}"
  else
    status 404
    'User not found.'
  end
end

# ダミーのユーザーデータ取得関数
def fetch_user_data(user_id)
  # 実際にはデータベースなどからデータを取得する
  users = {
    '101' => 'Alice',
    '102' => 'Bob',
    '103' => 'Charlie'
  }
  users[user_id]
end

# 実行方法:
# 1. このファイルを保存
# 2. ターミナルで `ruby demo/idor_vulnerability.rb` を実行
# 3. ブラウザで `http://localhost:4567/user_info/101` にアクセスすると Alice の情報が表示される。
# 4. ログインしていない、または権限のないユーザーが `http://localhost:4567/user_info/102` にアクセスすると、
#    本来アクセス権限がないはずの Bob の情報が表示されてしまう可能性がある。
